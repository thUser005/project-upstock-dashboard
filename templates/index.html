<!DOCTYPE html>
<html>
  <head>
    <title>Options Breakout Dashboard</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: linear-gradient(180deg, #0f172a, #020617);
        color: #e5e7eb;
      }

      .sticky-bar {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: linear-gradient(90deg, #1e3a8a, #020617);
        padding: 14px;
        border-bottom: 3px solid #3b82f6;
      }

      .card {
        background: #020617;
        border-radius: 12px;
        border: 1px solid #334155;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.55);
      }

      .card-header {
        background: linear-gradient(90deg, #2563eb, #1e40af) !important;
        border-bottom: 2px solid #60a5fa;
        font-size: 15px;
        letter-spacing: 0.5px;
      }

      table {
        font-size: 14px;
        border-collapse: separate;
        border-spacing: 0;
      }

      thead th {
        background: linear-gradient(180deg, #1e293b, #0f172a) !important;
        color: #f8fafc !important;
        border-bottom: 2px solid #475569 !important;
        border-right: 1px solid #334155;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.4px;
      }

      tbody td {
        background: #020617;
        color: #e5e7eb;
        border-right: 1px solid #334155;
        border-bottom: 1px solid #334155;
      }

      tbody tr {
        background: #020617;
      }

      tbody tr:nth-child(odd) td {
        background: #020617;
      }

      tbody tr:nth-child(even) td {
        background: #020617;
      }

      tbody tr + tr td {
        border-top: 1px solid #475569;
      }

      tbody tr:hover td {
        background: #020617;
        box-shadow: inset 0 0 0 9999px rgba(59, 130, 246, 0.08);
      }

      .ltp {
        font-weight: bold;
        color: #38bdf8;
        text-shadow: 0 0 8px rgba(56, 189, 248, 0.6);
      }

      .status-box {
        background: linear-gradient(180deg, #000, #020617);
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 16px;
        min-width: 44px;
        border: 1px solid #475569;
        box-shadow: inset 0 0 6px rgba(255, 255, 255, 0.08);
      }

      .btn-index {
        margin: 0 6px;
        font-weight: bold;
        box-shadow: 0 0 14px rgba(250, 204, 21, 0.7);
      }

      .market-msg {
        font-size: 14px;
        color: #facc15;
        font-weight: 600;
      }

      h3 {
        color: #f8fafc;
        text-shadow: 0 0 12px rgba(59, 130, 246, 0.7);
      }
    </style>
  </head>

  <body>
    <div class="sticky-bar text-center">
      <button class="btn btn-warning btn-index" onclick="scrollToSection('BANKNIFTY')">BANKNIFTY</button>
      <button class="btn btn-warning btn-index" onclick="scrollToSection('NIFTY')">NIFTY</button>
      <button class="btn btn-warning btn-index" onclick="scrollToSection('SENSEX')">SENSEX</button>
      <div id="marketStatus" class="market-msg mt-2"></div>
    </div>

    <div class="container-fluid mt-4">
      <h3 class="text-center mb-4">üìä Options Breakout Dashboard</h3>
      <div class="text-center mb-3">
        <span class="badge bg-info text-dark fs-6 px-3 py-2">
          üîÑ LTP Fetch Progress:
          <span id="ltpCurrent">0</span> /
          <span id="ltpTotal">0</span>
        </span>
      </div>

      {% for index_name in ['BANKNIFTY','NIFTY','SENSEX'] %}
      <div class="card mb-4" id="{{ index_name }}">
        <div class="card-header text-white fw-bold">{{ index_name }}</div>

        <div class="card-body p-0">
          <table class="table text-center mb-0">
            <thead>
              <tr>
                <th>Expiry</th>
                <th>Option</th>
                <th>Type</th>
                <th>Breakout</th>
                <th>Entry</th>
                <th>Target</th>
                <th>Stoploss</th>
                <th>LTP</th>
                <th>üéØ Target</th>
                <th>üõë SL</th>
              </tr>
            </thead>
            <tbody>
              {% for r in rows if r.index == index_name %}
              <tr
                data-option="{{ r.symbol }}"
                data-type="{{ r.type }}"
                data-target="{{ r.target }}"
                data-stoploss="{{ r.stoploss }}"
              >
                <td>{{ r.expiry }}</td>
                <td class="fw-bold text-info">{{ r.symbol }}</td>
                <td>
                  {% if r.type == 'CE' %}
                  <span class="badge bg-success">CE</span>
                  {% else %}
                  <span class="badge bg-danger">PE</span>
                  {% endif %}
                </td>

                <td class="text-warning fw-semibold">{{ r.breakout }}</td>
                <td class="text-primary fw-semibold">{{ r.entry }}</td>
                <td class="text-success fw-bold">{{ r.target }}</td>
                <td class="text-danger fw-bold">{{ r.stoploss }}</td>

                <td class="ltp">--</td>
                <td><div class="status-box target-status">‚¨ú</div></td>
                <td><div class="status-box sl-status">‚¨ú</div></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    </div>

    <script>
      let ltpCurrent = 0;
      let ltpTotal = 0;

      function updateLtpCounter() {
        document.getElementById("ltpCurrent").textContent = ltpCurrent;
        document.getElementById("ltpTotal").textContent = ltpTotal;
      }

      function getISTTime() {
        const now = new Date();
        const utc = now.getTime() + now.getTimezoneOffset() * 60000;
        return new Date(utc + 5.5 * 60 * 60 * 1000);
      }

      function marketPhase() {
        const now = getISTTime();
        const h = now.getHours();
        const m = now.getMinutes();

        if (h < 9 || (h === 9 && m < 15)) return "PRE";
        if (h > 15 || (h === 15 && m >= 30)) return "POST";
        return "LIVE";
      }

      function scrollToSection(id) {
        document.getElementById(id).scrollIntoView({ behavior: "smooth" });
      }

      async function fetchLTP(row) {
        const optionId = row.dataset.option;
        const type = row.dataset.type;
        const target = parseFloat(row.dataset.target);
        const stoploss = parseFloat(row.dataset.stoploss);

        try {
          // ‚úÖ CALL YOUR FASTAPI PROXY (NOT RAILWAY DIRECTLY)
          const res = await fetch(`/api/ltp/${optionId}`);
          const data = await res.json();

          if (data && data.ltp !== undefined && data.ltp !== null) {
            row.querySelector(".ltp").textContent = data.ltp;

            const targetBox = row.querySelector(".target-status");
            const slBox = row.querySelector(".sl-status");

            targetBox.textContent = "‚¨ú";
            slBox.textContent = "‚¨ú";

            if (type === "CE") {
              if (data.ltp >= target) {
                targetBox.textContent = "‚úîÔ∏è";
                targetBox.style.color = "lime";
              } else if (data.ltp <= stoploss) {
                slBox.textContent = "‚ùå";
                slBox.style.color = "red";
              }
            } else {
              if (data.ltp <= target) {
                targetBox.textContent = "‚úîÔ∏è";
                targetBox.style.color = "lime";
              } else if (data.ltp >= stoploss) {
                slBox.textContent = "‚ùå";
                slBox.style.color = "red";
              }
            }
          }
        } catch (e) {
          console.error(optionId, e);
        } finally {
          ltpCurrent++;
          updateLtpCounter();
        }
      }

      const phase = marketPhase();
      const statusBox = document.getElementById("marketStatus");

      if (phase === "PRE") {
        statusBox.textContent =
          "‚è≥ Market opens at 09:15 IST ‚Äì live prices not available yet";
      }

      if (phase === "LIVE") {
        statusBox.textContent = "üü¢ Market Live ‚Äì prices updating";

        function runLtpCycle() {
          ltpCurrent = 0;
          ltpTotal = document.querySelectorAll("tr[data-option]").length;
          updateLtpCounter();
          document.querySelectorAll("tr[data-option]").forEach(fetchLTP);
        }

        runLtpCycle();
        setInterval(runLtpCycle, 10000);
      }

      if (phase === "POST") {
        statusBox.textContent =
          "üîí Market closed ‚Äì showing final data (no live updates)";
      }
    </script>
  </body>
</html>
